{% extends "audio/base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <h1>NeuroTone — Real-Time</h1>
  <p class="sub">Подключите вход/выход, задайте параметры и нажмите <b>Start</b>.</p>

  <div class="card rt-grid">
    <div>
      <label>Input device (микрофон)</label>
      <select id="inDev"></select>

      <label>Samplerate (опционально)</label>
      <input id="sr" placeholder="пусто = по умолчанию устройства"/>

      <label>Trigger sensitivity</label>
      <div class="range-row">
        <input type="range" id="trig" min="0.02" max="0.30" step="0.01" value="0.08"/>
        <span class="range-help"><span id="trigVal">0.08</span> (ниже → агрессивнее)</span>
      </div>

      <div class="chk"><input type="checkbox" id="protect" checked/><label for="protect">Protect speech (сохранять чёткость речи)</label></div>
      <div class="chk"><input type="checkbox" id="vacuum" checked/><label for="vacuum">Vacuum (вне речи)</label></div>
    </div>

    <div>
      <label>Output device (наушники)</label>
      <select id="outDev"></select>

      <label>Block size (frames)</label>
      <input id="block" value="480"/>

      <label>Vacuum strength</label>
      <div class="range-row">
        <input type="range" id="vac" min="0" max="1" step="0.01" value="1.0"/>
        <span class="range-help"><span id="vacVal">1.00</span> (сила приглушения вне речи)</span>
      </div>

      <div class="chk"><input type="checkbox" id="triggers" checked/><label for="triggers">Trigger kill (убирать чавканье/тик-так/клаву)</label></div>
      <div class="chk"><input type="checkbox" id="ultra" checked/><label for="ultra">Ultra ANC (сильнее приглушение вне речи)</label></div>
    </div>
  </div>

  <div class="btn-row">
    <button id="btnTriggers" class="btn btn-secondary">Выбрать триггеры…</button>
    <span class="muted">Выбрано: <span id="selCount">—</span></span>
  </div>

  <div class="btn-row">
    <button id="start" class="btn btn-primary">Start</button>
    <button id="stop" class="btn btn-danger">Stop</button>
    <span id="status" class="muted">stopped</span>
  </div>

  <div id="err" class="error" style="display:none"></div>

  <div class="stats">
    <div><span>Frames</span><b id="stFrames">0</b></div>
    <div><span>Samplerate</span><b id="stSR">—</b></div>
    <div><span>Channels</span><b id="stCh">—</b></div>
    <div><span>Block</span><b id="stBlk">—</b></div>
  </div>
</div>

<!-- Nowbar / Drawer -->
<div id="drawer" class="drawer">
  <div class="drawer-panel">
    <div class="drawer-head">
      <h3>Выбор триггеров (YAMNet)</h3>
      <button id="drClose" class="btn btn-ghost">×</button>
    </div>
    <div class="drawer-tools">
      <input id="search" placeholder="поиск по названию…" />
      <div class="tool-btns">
        <button id="selAll" class="btn btn-ghost">Выбрать все</button>
        <button id="selNone" class="btn btn-ghost">Снять все</button>
        <button id="selCommon" class="btn btn-ghost">Частые триггеры</button>
      </div>
    </div>
    <div id="list" class="drawer-list"></div>
    <div class="drawer-foot">
      <button id="apply" class="btn btn-primary">Применить</button>
    </div>
  </div>
</div>

<script>
const $ = (q)=>document.querySelector(q);
const api = {
  devices: "{% url 'rt_devices' %}",
  triggers: "{% url 'rt_triggers' %}",
  start: "{% url 'rt_start' %}",
  stop: "{% url 'rt_stop' %}",
  stats: "{% url 'rt_stats' %}",
};

let TRIGGERS = [];     // [{id,label,ru}]
let selected = new Set(); // selected ids

function fmt(n){return (Math.round(n*100)/100).toFixed(2)}

function uiError(msg){ const e=$("#err"); e.style.display="block"; e.textContent="Ошибка: " + msg }
function uiInfoClear(){ const e=$("#err"); e.style.display="none"; e.textContent="" }

function fillDevices(items){
  const inSel = $("#inDev"), outSel = $("#outDev");
  inSel.innerHTML=""; outSel.innerHTML="";
  items.forEach(d=>{
    if(d.in>0){
      const o=document.createElement("option");
      o.value=d.index; o.textContent=d.name;
      inSel.appendChild(o);
    }
    if(d.out>0){
      const o=document.createElement("option");
      o.value=d.index; o.textContent=d.name;
      outSel.appendChild(o);
    }
  });
}

async function loadDevices(){
  const r = await fetch(api.devices); const j=await r.json();
  if(!j.ok){ uiError(j.error||"devices error"); return; }
  fillDevices(j.items);
}

function renderDrawer(list){
  const box=$("#list"); box.innerHTML="";
  list.forEach((it,idx)=>{
    const id = "tr_"+idx;
    const row=document.createElement("div");
    row.className="row";
    const ch=document.createElement("input");
    ch.type="checkbox"; ch.id=id; ch.checked=selected.has(it.id);
    ch.addEventListener("change",()=>{ if(ch.checked) selected.add(it.id); else selected.delete(it.id); refreshSelCount(); });
    const lab=document.createElement("label");
    lab.htmlFor=id;
    lab.innerHTML = `<b>${it.ru || it.label}</b><span>${it.label}</span>`;
    row.appendChild(ch); row.appendChild(lab);
    box.appendChild(row);
  });
}

function refreshSelCount(){ $("#selCount").textContent = selected.size ? selected.size : "—"; }

async function loadTriggers(){
  const r=await fetch(api.triggers); const j=await r.json();
  if(!j.ok){ uiError(j.error||"triggers error"); return; }
  TRIGGERS = j.items;
  // по умолчанию – частые
  const common = new Set([
    "Chewing, mastication","Lip smacking","Crunch",
    "Typing","Computer keyboard","Mouse click","Mouse","Keys jangling",
    "Knock","Tap","Clapping","Tick-tock","Gulp","Cough","Sneeze","Sniff"
  ]);
  selected = new Set(TRIGGERS.filter(t=>common.has(t.label)).map(t=>t.id));
  renderDrawer(TRIGGERS);
  refreshSelCount();
}

function filterList(q){
  q = q.trim().toLowerCase();
  if(!q){ renderDrawer(TRIGGERS); return; }
  const f = TRIGGERS.filter(it=>{
    return (it.ru && it.ru.toLowerCase().includes(q)) || (it.label && it.label.toLowerCase().includes(q));
  });
  renderDrawer(f);
}

async function start(){
  uiInfoClear();
  const body = {
    in_index: parseInt($("#inDev").value),
    out_index: parseInt($("#outDev").value),
    samplerate: $("#sr").value ? parseInt($("#sr").value) : null,
    block: parseInt($("#block").value || "480"),
    channels: 1,
    cfg: {
      trigger_sensitivity: parseFloat($("#trig").value),
      vacuum_strength: parseFloat($("#vac").value),
      protect_speech: $("#protect").checked,
      enable_triggers: $("#triggers").checked,
      enable_vacuum: $("#vacuum").checked,
      enable_denoise: true,
      ultra_anc: $("#ultra").checked,
    },
    triggers: Array.from(selected),
  };
  const r = await fetch(api.start, {method:"POST", body: JSON.stringify(body)});
  const j = await r.json();
  if(!j.ok){ uiError(j.error||"start error"); return; }
  $("#status").textContent="running";
  $("#stSR").textContent=j.samplerate; $("#stCh").textContent=j.channels; $("#stBlk").textContent=j.block;
}

async function stop(){
  const r = await fetch(api.stop, {method:"POST"});
  const j = await r.json();
  if(!j.ok){ uiError(j.error||"stop error"); return; }
  $("#status").textContent="stopped";
}

async function poll(){
  try{
    const r=await fetch(api.stats); const j=await r.json();
    if(j.ok){
      $("#stFrames").textContent=j.frames||0;
    }
  }catch(e){}
  setTimeout(poll, 700);
}

document.addEventListener("DOMContentLoaded", async ()=>{
  $("#trig").addEventListener("input", ()=>$("#trigVal").textContent=fmt(parseFloat($("#trig").value)));
  $("#vac").addEventListener("input", ()=>$("#vacVal").textContent=fmt(parseFloat($("#vac").value)));

  $("#start").addEventListener("click", start);
  $("#stop").addEventListener("click", stop);

  $("#btnTriggers").addEventListener("click", ()=>{$("#drawer").classList.add("open")});
  $("#drClose").addEventListener("click", ()=>{$("#drawer").classList.remove("open")});
  $("#apply").addEventListener("click", ()=>{$("#drawer").classList.remove("open"); refreshSelCount();});

  $("#selAll").addEventListener("click", ()=>{ selected = new Set(TRIGGERS.map(t=>t.id)); renderDrawer(TRIGGERS); refreshSelCount(); });
  $("#selNone").addEventListener("click", ()=>{ selected.clear(); renderDrawer(TRIGGERS); refreshSelCount(); });
  $("#selCommon").addEventListener("click", ()=>{
    const common = new Set([
      "Chewing, mastication","Lip smacking","Crunch","Typing","Computer keyboard","Mouse click","Mouse","Keys jangling",
      "Knock","Tap","Clapping","Tick-tock","Gulp","Cough","Sneeze","Sniff"
    ]);
    selected = new Set(TRIGGERS.filter(t=>common.has(t.label)).map(t=>t.id));
    renderDrawer(TRIGGERS); refreshSelCount();
  });

  $("#search").addEventListener("input", (e)=>filterList(e.target.value));

  await loadDevices();
  await loadTriggers();
  poll();
});
</script>

<style>
.container{max-width:1000px;margin:32px auto}
.sub{opacity:.8}
.rt-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.card{background:#0e1624;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
label{display:block;margin-top:14px;margin-bottom:6px;color:#aab6d3}
select,input{width:100%;background:#0b1220;color:#e8eeff;border:1px solid #1f2a44;border-radius:10px;padding:10px}
input::placeholder{color:#4c5b83}
.range-row{display:flex;align-items:center;gap:10px}
.range-row input[type=range]{flex:1}
.range-help{opacity:.8}
.chk{margin-top:10px;display:flex;gap:8px;align-items:center}
.btn-row{display:flex;gap:12px;align-items:center;margin:16px 0}
.btn{border:none;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:600}
.btn-primary{background:#3b82f6;color:#fff} .btn-danger{background:#ef4444;color:#fff}
.btn-secondary{background:#334155;color:#e5edff}
.btn-ghost{background:transparent;color:#cbd5e1;border:1px solid #334155}
.muted{opacity:.75}
.error{margin-top:12px;background:#471a20;color:#ffd0d4;border:1px solid #7a2630;padding:10px;border-radius:12px}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:18px}
.stats>div{background:#0e1624;border:1px solid #1f2a44;border-radius:12px;padding:12px}
.stats span{opacity:.7}

/* drawer */
.drawer{position:fixed;inset:0;display:none;background:rgba(0,0,0,.45);z-index:50}
.drawer.open{display:block}
.drawer-panel{position:absolute;right:0;top:0;height:100%;width:min(520px,95%);background:#0b1220;border-left:1px solid #1f2a44;display:flex;flex-direction:column}
.drawer-head{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #1f2a44}
.drawer-tools{display:flex;gap:10px;align-items:center;padding:12px;border-bottom:1px solid #1f2a44}
.drawer-tools input{flex:1}
.tool-btns{display:flex;gap:8px}
.drawer-list{flex:1;overflow:auto;padding:10px 14px}
.drawer-list .row{display:flex;gap:10px;align-items:flex-start;border-bottom:1px dashed #1f2a44;padding:8px 0}
.drawer-list .row label b{color:#e8eeff;display:block}
.drawer-list .row label span{opacity:.65;font-size:.9rem}
.drawer-foot{padding:12px;border-top:1px solid #1f2a44;display:flex;justify-content:flex-end}
</style>
{% endblock %}
