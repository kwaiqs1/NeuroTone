{% extends "audio/base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <h1>NeuroTone — Real-Time</h1>
  <p class="sub">Подключите вход/выход, задайте параметры и нажмите <b>Start</b>.</p>

  <div class="card rt-grid">
    <div>
      <label>Input device (микрофон)</label>
      <select id="inDev" disabled></select>

      <label>Samplerate (опционально)</label>
      <input id="srInput" type="text" placeholder="пусто = по умолчанию устройства"/>

      <label>Trigger sensitivity</label>
      <input id="trigRange" type="range" min="0.02" max="0.50" step="0.01" value="0.08">
      <div class="hint">0.08 (ниже → агрессивнее)</div>

      <label class="check">
        <input id="protectSpeech" type="checkbox" checked>
        <span>Protect speech (сохранять чёткость речи)</span>
      </label>

      <label class="check">
        <input id="vacuumMode" type="checkbox" checked>
        <span>Vacuum (вне речи)</span>
      </label>
    </div>

    <div>
      <label>Output device (наушники)</label>
      <select id="outDev" disabled></select>

      <label>Block size (frames)</label>
      <input id="blockInput" type="number" min="120" step="60" value="480"/>

      <label>Vacuum strength</label>
      <input id="vacRange" type="range" min="0.20" max="1.00" step="0.05" value="1.00">
      <div class="hint">1.00 (сила приглушения вне речи)</div>

      <label class="check">
        <input id="killTriggers" type="checkbox" checked>
        <span>Trigger kill (убирать чавканье/тик-так/клаву)</span>
      </label>

      <label class="check">
        <input id="ultraAnc" type="checkbox">
        <span>Ultra ANC (сильнее приглушение вне речи)</span>
      </label>
    </div>
  </div>

  <div style="margin-top:14px;display:flex;gap:12px;align-items:center">
    <button id="chooseTrig" class="btn">Выбрать триггеры…</button>
    <div>Выбрано: <span id="chosenTrig">—</span></div>
  </div>

  <div class="controls">
    <button id="startBtn" class="btn primary">Start</button>
    <button id="stopBtn" class="btn danger">Stop</button>
    <div id="stateDot" class="state stopped">stopped</div>
  </div>

  <div id="errBox" class="error" style="display:none"></div>

  <div class="stats">
    <div class="stat"><b>Frames</b><span id="stFrames">—</span></div>
    <div class="stat"><b>Samplerate</b><span id="stSR">—</span></div>
    <div class="stat"><b>Channels</b><span id="stCH">—</span></div>
    <div class="stat"><b>Block</b><span id="stBL">—</span></div>
  </div>
</div>

<!-- Крошечные стили для доступности -->
<style>
  .rt-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  label{display:block;margin:12px 0 6px}
  select, input[type="text"], input[type="number"]{width:100%;height:40px;background:#0e1729;border:1px solid #223252;color:#e8eeff;border-radius:10px;padding:0 12px}
  input[type="range"]{width:100%}
  .hint{opacity:.6;font-size:.9rem;margin-top:2px}
  .check{display:flex;gap:8px;align-items:center;margin:10px 0}
  .controls{display:flex;gap:10px;align-items:center;margin-top:14px}
  .btn{height:40px;padding:0 16px;border-radius:10px;background:#1a2846;border:1px solid #2a3b5f;color:#e8eeff}
  .btn.primary{background:#2563eb;border-color:#2563eb}
  .btn.danger{background:#ef4444;border-color:#ef4444}
  .state{margin-left:8px;opacity:.8}
  .state.running{color:#34d399}
  .state.stopped{color:#ef4444}
  .error{margin-top:12px;padding:12px;border-radius:10px;background:#401a1f;border:1px solid #7a2d36;color:#ffd6d9}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
  .stat{background:#0e1729;border:1px solid #223252;border-radius:10px;padding:10px 12px}
  .stat b{display:block;opacity:.7;margin-bottom:4px}
</style>

<script>
(function(){
  const inSel   = document.getElementById('inDev');
  const outSel  = document.getElementById('outDev');
  const srInput = document.getElementById('srInput');
  const blockIn = document.getElementById('blockInput');
  const trigR   = document.getElementById('trigRange');
  const vacR    = document.getElementById('vacRange');
  const protect = document.getElementById('protectSpeech');
  const vacuumM = document.getElementById('vacuumMode');
  const killT   = document.getElementById('killTriggers');
  const ultra   = document.getElementById('ultraAnc');

  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const errBox   = document.getElementById('errBox');
  const stateDot = document.getElementById('stateDot');

  const stFrames = document.getElementById('stFrames');
  const stSR     = document.getElementById('stSR');
  const stCH     = document.getElementById('stCH');
  const stBL     = document.getElementById('stBL');

  const chosenUI = document.getElementById('chosenTrig');
  const chooseBtn= document.getElementById('chooseTrig');
  let chosenTriggers = [];

  function showErr(msg){
    errBox.style.display = 'block';
    errBox.textContent = 'Ошибка: ' + msg;
  }
  function clearErr(){
    errBox.style.display = 'none';
    errBox.textContent = '';
  }
  function setRunning(r){
    stateDot.textContent = r ? 'running' : 'stopped';
    stateDot.classList.toggle('running', r);
    stateDot.classList.toggle('stopped', !r);
  }

  async function postJSON(url, data) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      credentials: 'same-origin',
    });
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      return await res.json();
    } else {
      const text = await res.text();
      throw new Error(text);
    }
  }

  async function loadDevices(){
    clearErr();
    inSel.innerHTML = '<option>Загрузка…</option>';
    outSel.innerHTML = '<option>Загрузка…</option>';
    const {ok, data} = await api('/rt/devices');
    if(!ok){
      inSel.innerHTML = '';
      outSel.innerHTML = '';
      showErr(data.error || 'Не удалось получить список устройств');
      return;
    }
    // Заполняем список
    inSel.innerHTML = '';
    (data.inputs||[]).forEach(d=>{
      const o = document.createElement('option');
      o.value = String(d.index);
      o.textContent = d.label;
      inSel.appendChild(o);
    });
    outSel.innerHTML = '';
    (data.outputs||[]).forEach(d=>{
      const o = document.createElement('option');
      o.value = String(d.index);
      o.textContent = d.label;
      outSel.appendChild(o);
    });

    inSel.disabled = (inSel.options.length===0);
    outSel.disabled = (outSel.options.length===0);

    if(data.default_in != null)  inSel.value  = String(data.default_in);
    if(data.default_out != null) outSel.value = String(data.default_out);

    if(inSel.options.length===0 || outSel.options.length===0){
      showErr('Не найдено подходящих аудио-устройств. Откройте «Звук → Вход/Выход» в Windows и убедитесь, что микрофон/наушники активны.');
    }
  }

  async function loadTriggers(){
    const {ok, data} = await api('/rt/triggers');
    if(!ok){ return; }
    const items = data.items || [];
    // диалог выбора (минималистичный prompt)
    chooseBtn.onclick = ()=>{
      const list = items.map((t,i)=>`${i+1}. ${t}`).join('\n');
      const ans = prompt('Введите номера триггеров через запятую:\n\n'+list+'\n\nПример: 1,4,7');
      if(!ans) return;
      const pick = ans.split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n) && n>=1 && n<=items.length);
      chosenTriggers = Array.from(new Set(pick.map(n=>items[n-1])));
      chosenUI.textContent = chosenTriggers.length ? chosenTriggers.join(', ') : '—';
    };
  }

  async function start(){
    clearErr();
    if(inSel.disabled || outSel.disabled){
      showErr('Список устройств пуст. Нажмите F5 для повторной загрузки / или проверьте подключение устройств.');
      return;
    }
    const payload = {
      in:  parseInt(inSel.value,10),
      out: parseInt(outSel.value,10),
      sr:  srInput.value ? parseInt(srInput.value,10) : null,
      block: parseInt(blockIn.value || '480',10),
      sensitivity: parseFloat(trigR.value),
      vacuum_strength: parseFloat(vacR.value),
      protect_speech: protect.checked,
      trigger_kill:   killT.checked,
      ultra_anc:      ultra.checked,
      triggers:       chosenTriggers
    };
    const {ok, data} = await api('/rt/start', {method:'POST', body: JSON.stringify(payload)});
    if(!ok){ showErr(data.error || 'Не удалось запустить поток'); setRunning(false); return; }
    stSR.textContent = data.sr || '—';
    stBL.textContent = data.block || '—';
    stCH.textContent = data.channels || '—';
    stFrames.textContent = '0';
    setRunning(true);
  }

  async function stop(){
    clearErr();
    await api('/rt/stop', {method:'POST', body:'{}'});
    setRunning(false);
  }

  async function poll(){
    const {ok, data} = await api('/rt/stats');
    if(ok){
      stFrames.textContent = data.frames != null ? String(data.frames) : '—';
      stSR.textContent     = data.samplerate || '—';
      stCH.textContent     = data.channels || '—';
      stBL.textContent     = data.block || '—';
      if(data.last_error){ showErr(data.last_error); }
      setRunning(!!data.running);
    }
  }

  // init
  loadDevices();
  loadTriggers();
  startBtn.onclick = start;
  stopBtn.onclick = stop;
  setInterval(poll, 800);
})();
</script>
{% endblock %}
